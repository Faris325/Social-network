{% extends "base.html" %}
{% load static %}

{% block css %}
  <link rel="stylesheet" href="{% static 'css/messages.css' %}">
  <link rel="stylesheet" href="{% static 'css/message_item.css' %}">
  
{% endblock css %}

{% block content %}
<div class="app-container" role="main">

  <!-- Список диалогов -->
  <aside class="dialogs-list" aria-label="Список диалогов">
    <h2>Диалоги</h2>
    <a href="{% url "user_messages:messages" user.id %}" class="dialog-link">  
      <div class="dialog-item {% if user == dialog_user %}custom-gray-bg{% endif %}">
        <div class="dialog-avatar">⭐</div>
        <div class="dialog-username">Избранное</div>
      </div>
    </a> 
    {% for u in users %}
      <a href="{% url "user_messages:messages" u.id %}" class="dialog-link">  
        {% if u != user %}
        <div class="dialog-item {% if u == dialog_user %}custom-gray-bg{% endif %}">
            <div class="dialog-avatar">
              {% if u.image %}
                <img src="{{ u.image.url }}" alt="фото" class="message-avatar-img">
              {% else %}
                <img src="{% static 'image/profile_image/profile.webp' %}" alt="фото" class="message-avatar-img">
              {% endif %}
            </div>
            <div class="dialog-username">{{ u.nickname}}</div>
        </div>
        {% endif %}
      </a>
    {% endfor %}
  </aside>
  {% if chat_user %}
    {% include "includes/message_item.html" %}
  {% else %}
    <section class="chat-panel" aria-label="Диалог с пользователем">
      <div class="chat-header">Выберите диалог</div>
    </section>
  {% endif %}
</div>


<!-- Скрипты -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const otherUserId = {{ dialog_user.id }};  // id собеседника
  const currentUserId = {{ user.id }}; // id текущего пользователя 
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws"; // Выбор ws или wss в зависимости от http или https 

  const chatSocket = new WebSocket(
    wsScheme + "://" + window.location.host + `/ws/chat/${otherUserId}/` // открытие веб-сокет соединения
  );

  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    const message = data.message;
    const media = data.media_file;
    const senderId = data.sender_id;

    const chatLog = document.getElementById("chatMessages");

    const msgElement = document.createElement("div");
    msgElement.classList.add("message-item");

    msgElement.classList.add(
      senderId === currentUserId ? "sent" : "received"
    );

    const content = document.createElement("div");
    content.classList.add("message-content");

    // Текст сообщения 
    if (message) {
      const p = document.createElement("p");
      p.textContent = message;
      content.appendChild(p);
    }

    // Медиа
    if (media) {
      const img = document.createElement("img");
      img.src = media;
      img.alt = "media content";
      img.classList.add("message-media");
      content.appendChild(img);
    }

    // Время
    const time = document.createElement("span");
    time.classList.add("timestamp");
    time.textContent = new Date().toLocaleString();
    content.appendChild(time);

    msgElement.appendChild(content);
    chatLog.appendChild(msgElement);

    chatLog.scrollTop = chatLog.scrollHeight;
  };

  document.getElementById("chat-message-form").onsubmit = function(e) {   // Код срабатывает в момент отправки формы 
    e.preventDefault(); // отменяет перезагрузку страницы при отправке формы 

    const input = document.getElementById("chat-message-input");  // находит поле ввода сообщения 
    const message = input.value.trim(); // берёт текст из поля и убирает пробелы в начале и конце


    const input_media = document.getElementById("upload_media"); // находит поле медиа-файла
    const media_file = input_media.files[0];
    const reader = new FileReader();
    if (!message && !media_file) return;// если сообщение пустое — ничего не отправляем и выходим из функции

    if (media_file) {
      reader.onload = function() {
        const base64data = reader.result; // файл в base64

        // Отправляем сообщение и файл по WebSocket
        chatSocket.send(JSON.stringify({
          message: message,
          media_file: base64data
        }));

        // Очищаем поля
        input.value = "";
        input_media.value = "";
      };

      reader.readAsDataURL(media_file); // начинаем читать файл в base64
    } else {
      // Если файл не выбран — отправляем только сообщение
      chatSocket.send(JSON.stringify({
        message: message,
        media_file: null
      }));

      // Очищаем поле ввода после отправки сообщения
      input.value = "";
    }
  };
</script>


<script>
// Скрипт для прокуртки вниз после открытия дилаог


const chatLog = document.getElementById("chatMessages");
if (chatLog) {
  chatLog.scrollTop = chatLog.scrollHeight;
}


</script>
{% endblock content %}

