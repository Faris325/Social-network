{% extends "base.html" %}
{% load static %}
{% load tz %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/publications.css' %}">
{% endblock css %}

{% block content %}
<div class="profile-container mt-5">

    <!-- Вкладки -->
    <ul class="nav nav-tabs mt-3" id="publicationsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="popular-tab" data-bs-toggle="tab" data-bs-target="#popular" type="button" role="tab" aria-controls="popular" aria-selected="true">Популярные</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="friends-tab" data-bs-toggle="tab" data-bs-target="#friends" type="button" role="tab" aria-controls="friends" aria-selected="false">Друзья</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="topics-tab" data-bs-toggle="tab" data-bs-target="#topics" type="button" role="tab" aria-controls="topics" aria-selected="false">Темы</button>
        </li>
    </ul>

    <div class="tab-content mt-3" id="publicationsTabContent">
        <!-- Популярные публикации -->
        <div class="tab-pane fade show active" id="popular" role="tabpanel" aria-labelledby="popular-tab">
            {% for publication in popular_publications %}
            <div data-id="{{publication.id}}" class="publication-item pb-3 border-bottom position-relative">
                {% if user == publication.user %}
                    <button data-id="{{ publication.id }}" class="delete-publication btn btn-sm btn-light position-absolute top-0 end-0" style="font-size: 16px;">&#10006;</button>
                {% endif %}
                <div class="publication-header mb-2">
                    <strong>Тема: {{ publication.topic }}</strong>
                </div>
                <p>{{ publication.text }}</p>
                {% if publication.media %}
                <div class="publication-media mt-2">
                    {% if publication.media.name|lower|slice:"-4:" in ".mp4.avi" %}
                        <video controls class="img-fluid rounded">
                            <source src="{{ publication.media.url }}" type="video/mp4">
                            Ваш браузер не поддерживает воспроизведение видео.
                        </video>
                    {% else %}
                        <img src="{{ publication.media.url }}" alt="Publication media" class="img-fluid rounded">
                    {% endif %}
                </div>
                {% endif %}

                <div class="publication-actions mt-2 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <button data-id="{{ publication.id }}" class="like-publication">
                            {% if user in publication.liked_by.all %}
                                <img class="like_img" src="{% static 'image/active-like.png' %}" alt="Like">
                            {% else %}
                                <img class="dislike_img" src="{% static 'image/like.png' %}" alt="Like">
                            {% endif %}
                            <span class="action-chip">{{ publication.liked_by.count }}</span>
                           <button data-id="{{ publication.id }}" class="open-comments">
                                <span class="action-chip ms-2">
                                    <img src="{% static 'image/comments.png' %}" alt="Comments">
                                    {{ publication.comments_count }}
                                </span>
                            </button>
                    </div>
                    <span class="publication-time">{{ publication.created_at|timesince }} назад</span>
                </div>
            </div>
            {% empty %}
            <p>Публикаций нет</p>
            {% endfor %}
        </div>

        <!-- Публикации друзей -->
        <div class="tab-pane fade" id="friends" role="tabpanel" aria-labelledby="friends-tab">
            {% for publication in friends_publications %}
            <div data-id="{{publication.id}}" class="publication-item pb-3 border-bottom position-relative">
                <div class="publication-header mb-2">
                    <strong>{{ publication.user.nickname }}</strong>
                </div>
                <p>{{ publication.text }}</p>
                {% if publication.media %}
                <div class="publication-media mt-2">
                    {% if publication.media.name|lower|slice:"-4:" in ".mp4.avi" %}
                        <video controls class="img-fluid rounded">
                            <source src="{{ publication.media.url }}" type="video/mp4">
                            Ваш браузер не поддерживает воспроизведение видео.
                        </video>
                    {% else %}
                        <img src="{{ publication.media.url }}" alt="Publication media" class="img-fluid rounded">
                    {% endif %}
                </div>
                {% endif %}

                <div class="publication-actions mt-2 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <button data-id="{{ publication.id }}" class="like-publication">
                            {% if user in publication.liked_by.all %}
                                <img class="like_img" src="{% static 'image/active-like.png' %}" alt="Like">
                            {% else %}
                                <img class="dislike_img" src="{% static 'image/like.png' %}" alt="Like">
                            {% endif %}
                            <span class="action-chip">{{ publication.liked_by.count }}</span>
                        </button>
                        <button data-id="{{ publication.id }}" class="open-comments">
                            <span class="action-chip ms-2">
                                <img src="{% static 'image/comments.png' %}" alt="Comments">
                                {{ publication.comments_count }}
                            </span>
                        </button>

                    </div>
                    <span class="publication-time">{{ publication.created_at|timesince }} назад</span>
                </div>
            </div>
            {% empty %}
            <p>Публикаций друзей нет</p>
            {% endfor %}
        </div>

        <!-- Темы -->
        <div class="tab-pane fade" id="topics" role="tabpanel" aria-labelledby="topics-tab">
            <form id="topicSearchForm" method="get" action="{% url 'publications:search-topics' %}">
                <input type="text" id="topicSearch" class="form-control" name="q" placeholder="Поиск тем...">
            </form>

            {% for topic in topics %}
            <div class="publication-item pb-3 border-bottom">
                <a href="{% url "publications:publication-topic" topic %}"><strong>{{ topic}}</strong></a>
            </div>
            {% empty %}
            <p>Тем пока нет</p>
            {% endfor %}
        </div>
    </div>
</div>

{% comment %}модальное окно для публикаций{% endcomment %}
    <div class="modal fade" id="commentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
        <div class="modal-body" id="modal-body">
            
        </div>
        </div>
    </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>

const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');


// Полнотекстовый поиск тем 
const form_search = document.getElementById('topicSearchForm');
const search = document.getElementById('topicSearch');

search.onkeydown = (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        form_search.submit();
    }
};

// Открытие вкладки с темами, когда случился поиск 
{% if topics_tab_active %}
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById('topics-tab').click();
    });
{% endif %}


// для вывода комментариев у поста
document.querySelectorAll('.open-comments').forEach(button => {
    button.addEventListener('click', function () {
        const publicationId = this.dataset.id;
        const url = "{% url 'publications:publication-comments' %}?publication_id=" + publicationId;

        fetch(url, { method: 'GET' })
        .then(response => response.json())
        .then(data => {
            document.getElementById('modal-body').innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('commentsModal')).show();
        })
        .catch(error => console.error(error));
    });
});

// Удаление публикаций
document.querySelectorAll('.delete-publication').forEach(button => {
    button.addEventListener('click', function () {
        const publicationId = this.dataset.id;
        const buttonElement = this;

        fetch("{% url 'publications:publication-delete' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken,'Content-Type': 'application/json'},
            body: JSON.stringify({ publication_id: publicationId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') buttonElement.closest('.publication-item').remove();
            else alert('Ошибка при удалении');
        })
        .catch(error => console.error(error));
    });
});



// лайки публикаций 
document.body.addEventListener('click', function(e) {
    const button = e.target.closest('.like-publication');
    if (!button) return;

    const publicationId = button.dataset.id;

    fetch("{% url 'publications:publication-like' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/json'},
        body: JSON.stringify({ publication_id: publicationId })
    })
    .then(response => response.json())
    .then(data => {
        // Находим все кнопки с этим publicationId
        const buttons = document.querySelectorAll(`.like-publication[data-id="${publicationId}"]`);
        
        buttons.forEach(btn => {
            const likesSpan = btn.querySelector('.action-chip');
            const like_img = btn.querySelector('img');
            let count = parseInt(likesSpan.textContent) || 0;

            if (data.status === 'ok') {
                count += 1;
                likesSpan.textContent = count;
                like_img.src = "{% static 'image/active-like.png' %}";
            } else if (data.status === 'not_ok') {
                count = Math.max(count - 1, 0);
                likesSpan.textContent = count;
                like_img.src = "{% static 'image/like.png' %}";
            }
        });
    })
    .catch(error => console.error(error));
});



// для отправки комментария
document.body.addEventListener('submit', function(e) {
    const form = e.target.closest('#comment-form');
    if (!form) return;

    e.preventDefault();

    const input = form.querySelector('input[name="text"]');
    const text = input.value.trim();
    if (!text) return;

    const userNickname = form.dataset.senderId;
    const userDate = new Date().toLocaleString('ru-RU');

    fetch("{% url 'publications:add-comments' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text: text, publication_id: form.dataset.publicationId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            // Контейнер комментариев для текущей модалки
            const modalBody = form.closest('.publication-modal-content');
            const commentsList = modalBody.querySelector('#modal-comments');
            if (!commentsList) return;

            // Удаляем только сообщение "Комментариев пока нет"
            const emptyMsg = commentsList.querySelector('p.no_comment');
            if (emptyMsg) emptyMsg.remove();


            // Вставляем новый комментарий в конец списка
            commentsList.insertAdjacentHTML('beforeend', `
                <div class="comment border-bottom py-2">
                    <strong>${userNickname}</strong>
                    <p>${text}</p>
                    <small class="text-muted">${userDate}</small>
                </div>
            `);

            // Очищаем поле ввода
            input.value = '';
        } else {
            console.error('Ошибка при отправке комментария');
        }
    })
    .catch(error => console.error(error));
})
</script>

{% endblock content %}

